<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoho CRM Chatbot</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Main Chat Container: Full Screen -->
    <div id="chat-container" class="w-full max-w-full bg-white shadow-xl rounded-none flex flex-col h-screen overflow-hidden">
        
        <!-- Header -->
        <header class="p-4 bg-indigo-600 text-white shadow-md flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-3 h-3 bg-green-400 rounded-full mr-2 animate-pulse"></div>
                <h1 class="text-xl font-semibold">Zoho CRM AiChat</h1>
            </div>
            <span class="text-sm font-light opacity-80">Powered By Gemini</span>
        </header>

        <!-- Message Display Area -->
        <main id="chat-log" class="flex-grow p-4 overflow-y-auto space-y-4">
            <!-- Initial Welcome Message (Updated with Cchat name suggestion) -->
            <div class="flex justify-start">
                <div class="max-w-xs md:max-w-sm bg-gray-200 text-gray-800 p-3 rounded-t-xl rounded-br-xl shadow-sm text-sm">
                    Hello! I'm here to help you retrieve information from Zoho CRM's "Enquiry_Ai_Testing_1" module. What information are you looking for today? Please tell me what you'd like to search by (e.g., email, name, Case ID) and what details you need.
                </div>
            </div>

            <!-- Loading Indicator (Hidden by default) -->
            <div id="loading-indicator" class="hidden flex justify-start">
                <div class="max-w-xs md:max-w-sm bg-indigo-100 text-indigo-700 p-3 rounded-t-xl rounded-br-xl shadow-sm text-sm">
                    <div class="flex items-center space-x-2">
                        <svg class="animate-spin h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Typing...</span>
                    </div>
                </div>
            </div>
        </main>

        <!-- Input Area -->
        <div class="p-4 border-t border-gray-200 flex items-center bg-white">
            <input type="text" id="user-input" placeholder="Ask Chatbot" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150" autocomplete="off">
            <button id="send-button" onclick="sendMessage()" class="ml-3 bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-lg font-semibold shadow-md transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                Send
            </button>
        </div>
    </div>

    <!-- JavaScript for Webhook Interaction -->
    <script>
        const WEBHOOK_URL = 'https://datakernels.app.n8n.cloud/webhook/c34ae7ed-b276-4ece-829f-0b9475b24465'; //experimental
        //const WEBHOOK_URL = 'https://datakernels.app.n8n.cloud/webhook/3a33b819-c6c0-414f-9f73-cd9c2d1094db';  //final
        const FIELD_COUNT_THRESHOLD = 5; // Convert to table if more than 5 fields are detected

        // --- UI ELEMENTS ---
        const chatLog = document.getElementById('chat-log');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        let isSending = false;

        // Configuration for exponential backoff retries
        const MAX_RETRIES = 3;
        const BASE_DELAY_MS = 1000;


        // --- CORE UTILITIES ---

        /**
         * Utility function to fetch with retry and exponential backoff.
         */
        async function fetchWithRetry(url, options, retries = 0) {
            try {
                const response = await fetch(url, options);
                return response; 
            } catch (error) {
                if (retries < MAX_RETRIES) {
                    const delay = BASE_DELAY_MS * Math.pow(2, retries);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                }
                throw error;
            }
        }

        /**
         * Parses the incoming multi-line text (e.g., "Name: John\nAge: 30") into a structured array.
         * It assumes fields are separated by a colon (':'). It filters out null/empty values.
         * @param {string} text The raw text output from n8n.
         * @returns {Array<{key: string, value: string}>} A structured array of non-empty fields.
         */
        function parseOutputToFields(text) {
            const fields = [];
            // Split by newline and filter out empty lines
            const lines = text.split('\n').filter(line => line.trim() !== '');

            lines.forEach(line => {
                const parts = line.split(/:\s*/, 2); // Split only on the first colon followed by optional space
                if (parts.length === 2) {
                    const key = parts[0].trim();
                    const value = parts[1].trim();
                    
                    if (key) {
                        // Check if value is not empty, not just whitespace, and not a 'null' string
                        const lowerValue = value.toLowerCase();
                        const isValueValid = value !== '' && lowerValue !== 'null' && lowerValue !== 'undefined';
                        
                        if (isValueValid) {
                            fields.push({ key: key, value: value });
                        }
                    }
                }
            });
            return fields;
        }

        /**
         * Converts an array of fields into a vertical, scrollable HTML table.
         * @param {Array<{key: string, value: string}>} fields The structured field data.
         * @returns {string} HTML string for the table.
         */
        function formatAsTable(fields) {
            if (fields.length === 0) return '';

            let rows = '';

            fields.forEach(field => {
                rows += `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <th scope="row" class="px-4 py-2 text-sm font-medium text-left text-gray-700 bg-indigo-50 w-1/3">${field.key}</th>
                        <td class="px-4 py-2 text-sm text-gray-800 break-words w-2/3">${field.value}</td>
                    </tr>
                `;
            });

            // max-h-[350px] sets the scrollable height, and overflow-y-auto enables the scrollbar
            return `
                <div class="my-2 rounded-lg border border-gray-200 shadow-lg overflow-hidden max-h-[350px] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <tbody class="divide-y divide-gray-100">${rows}</tbody>
                    </table>
                </div>
            `;
        }


        /**
         * Utility function to create and display a message bubble.
         */
        function displayMessage(content, isUser) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = isUser ? 'flex justify-end' : 'flex justify-start';

            const messageBubble = document.createElement('div');
            // Allow table to take more width, otherwise keep it constrained.
            const maxWidthClass = content.includes('<table') ? 'max-w-full' : 'max-w-xs md:max-w-sm';

            messageBubble.className = isUser 
                ? `${maxWidthClass} bg-indigo-600 text-white p-3 rounded-t-xl rounded-bl-xl shadow-md text-sm`
                : `${maxWidthClass} bg-gray-200 text-gray-800 p-3 rounded-t-xl rounded-br-xl shadow-sm text-sm`;
            
            // If it's HTML (table), use innerHTML. Otherwise, handle newlines and use text content.
            if (content.includes('<table')) {
                messageBubble.innerHTML = content;
            } else {
                messageBubble.innerHTML = content.replace(/\n/g, '<br>');
            }

            messageWrapper.appendChild(messageBubble);
            chatLog.appendChild(messageWrapper);
            
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        /**
         * Main function to handle sending the message to the n8n webhook.
         */
        async function sendMessage() {
            if (isSending) return;

            const userText = userInput.value.trim();
            if (!userText) return;

            // 1. Display user message and clear input
            displayMessage(userText, true);
            userInput.value = '';

            // 2. Set loading state
            isSending = true;
            sendButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            chatLog.scrollTop = chatLog.scrollHeight;

            let botResponseText = "Sorry, I encountered an error while processing your request.";
            let rawResponseText = ""; // To hold the text regardless of JSON parsing

            try {
                const payload = {
                    user_query: userText
                };

                const response = await fetchWithRetry(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                // Check for non-200 HTTP codes (like 400 or 500)
                if (!response.ok) {
                    const status = response.status;
                    const errorBody = await response.text();
                    throw new Error(`n8n responded with HTTP Error ${status}. Please check your n8n flow for runtime errors. Response body: ${errorBody.substring(0, 150)}...`);
                }

                rawResponseText = await response.text();
                botResponseText = rawResponseText;

                // --- JSON PARSING AND EXTRACTION ---
                if (rawResponseText.includes("{") && rawResponseText.includes("}")) {
                     try {
                        const data = JSON.parse(rawResponseText);
                        
                        // Check for the specific "output" key
                        if (data && data.output) {
                            botResponseText = data.output;
                        } 
                        // Check for n8n error structure
                        else if (data && data.errorMessage) {
                            botResponseText = `n8n Flow Error: ${data.errorMessage}. Check the AI Agent input variable.`;
                        }
                        
                    } catch (e) {
                        // Not valid JSON, treat as raw text below
                    }
                }

                // --- TEXT CLEANUP (Removing Markdown/Junk) ---
                let cleanedText = botResponseText.replace(/\*\*/g, '').replace(/\* /g, '').trim();

                // --- ENHANCEMENT LOGIC: TABLE CONVERSION ---
                const fields = parseOutputToFields(cleanedText);
                
                if (fields.length > FIELD_COUNT_THRESHOLD) {
                    botResponseText = formatAsTable(fields);
                    // The table is HTML, so we don't need further text cleanup.
                } else {
                    // It's a short list or normal text, use the cleaned text
                    // If there are fields but not enough for a table, format them as a simple list
                    if (fields.length > 0) {
                        botResponseText = fields.map(f => `${f.key}: ${f.value}`).join('\n');
                    } else {
                         // If no fields found, just display the raw cleaned text
                         botResponseText = cleanedText;
                    }
                }
                
            } catch (error) {
                console.error("Error communicating with n8n Webhook:", error);
                botResponseText = `Connection Error: ${error.message}. If this persists, verify your n8n workflow is Active and running without errors.`;
            } finally {
                // 4. Reset loading state and display bot response
                loadingIndicator.classList.add('hidden');
                displayMessage(botResponseText, false);
                
                isSending = false;
                sendButton.disabled = false;
                userInput.focus();
            }
        }

        // Event listener for the Enter key on the input field
        userInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission behavior
                sendMessage();
            }
        });

    </script>
</body>
</html>
